# Hemiplasy hypothesis - inference-based approach


*environiments:* yaml.main 


*aim:* infer species trees / infer gene concordance factors (gCFs) / run HeIST

As input for HeIST, it is necessary to prepare a txt file including two species trees, one of which indicates the gene concordance factors (gCFs), a measure for quantifying genealogical concordance in phylogenomic datasets. For every branch of a reference tree, gCF is defined as the percentage of “decisive” gene trees containing that branch. 

**NB:** In order to test the performances of subsequent analyses on different subsets of data, both sets of orthogroups are split into two subsets: one including all orthogroups (with a minimum of 5 species each) and one including only orthogroups comprising all 10 species. 

Each of the following commands must thus be applied to four subsets, in total: 
* all aminoacids-composed orthogroups (min 5 species);
* aminoacids-composed orthogroups with minimimum 10 species;
* all nucleotides-composed orthogroups (min 5 species);
* nucleotides-composed orthogroups with minimimum 10 species.

## Infer species tree for both nucleotidic and aminoacidic sequences


**NB:** The species trees are inferred using this [script for aminoacidic sequences](https://github.com/MattiaRag/timemaproject/blob/main/scripts/species_tree_aa.sh) and this [script for nucleotidic sequences](https://github.com/MattiaRag/timemaproject/blob/main/scripts/species_tree_nu.sh). The current chapter provides a detailed description of commands constituting the concerned pipeline, taking aminoacidic sequences as example model. 


At first, all trimmed files are copied and paste into the new directory `sptree_aa/min_5sp`:


```
cp preliminary/orthogroupsdisco_aa/Trimmed_aa/*.fa species_trees/sptree_aa/min_5sp
```

One further directory called `sptree_aa/min_10sp` is generated and orthogroups' fastas including all 10 species are copied and paste in there. These steps are performed through a `for` cycle:

```
for i in species_trees/sptree_aa/min_5sp/*.fa; do
    # Count the number of headers in the file
    num_headers=$(grep -c '^>' "$i")

    # If the number of headers is greater than or equal to 10
    if [ "$num_headers" -ge 10 ]; then
        # Copy the file to min_10sp directory
        cp "$i" species_trees/sptree_aa/min_10sp/
    else
        echo "The file $i contains less than 10 headers. Skipping to the next step."
    fi
done
```

The following steps must be performed on both `min_5sp` and `min_10sp` directories.

Before concatenation, the fastas' headers are renamed keeping just the species names (e.g. TPA, TBI, etc.), while empty files are removed: 

```
awk '/^>/{split(species_trees/sptree_aa/min_5sp, arr, "_"); print arr[1]; next} {print}' "orth.fa" > species_trees/sptree_aa/min_5sp/Renamed/orth.rename
find species_trees/sptree_aa/min_5sp/Renamed -type f -size 0 -delete
```

Concatenation is then operated using AMAS.py on the `Renamed` directory:

```
python scripts/AMAS.py concat -y nexus -i species_trees/sptree_aa/min_5sp/Renamed/*.rename -f fasta -d aa -t species_trees/sptree_aa/min_5sp/Iqtreeinput/concat_file
```

The flag `-y` specifies the format of the output file. 
The flag `-d` is used to specify the type of data being processed. This flag takes value `aa` for aminoacidic and `dna` for nucleotidic sequences.
The flag `-f` is used to specify the format of the input files.

Concatenation is directly followed by IQ-TREE:

```
iqtree2 -m TESTNEW -bb 1000 -s species_trees/sptree_aa/min_5sp/Iqtreeinput/concat_file --prefix species_trees/sptree_aa/min_5sp/Iqtreeoutput/concat_file.faa -nt AUTO
```

The flag `-bb` enables ultrafast bootstrap analysis with 1000 bootstrap replicates.
The flag `--prefix` sets the prefix for all output files generated by IQ-TREE.
The flag `-m TESTNEW` specifies the model selection strategy, involving a comprehensive model selection method that tests all substitution models and chooses the best one.


## Infer gene concordance factors (gCFs)


Once inferred the gene trees and species trees with both aminoacidic and nucleotidic sequences, it is possible to infer the gene concordance factors. 

**NB:** all commands needed for obtaining gCFs have been implemented within this [script](https://github.com/MattiaRag/timemaproject/blob/main/scripts/gCF.sh).

The concordance factors can be easily inferred through a single command line:

```
iqtree2 -t concat.treefile --gcf loci.treefile --prefix concord
```

The flag `-t` specifies the species tree.
The flag `--gcf` specifies a `loci.treefile`, a file including the list of gene trees in newick format. 

## Run HeIST

#### Prepare the NEXUS input for HeIST

The input file for HeIST is a modified NEXUS format. It includes two species trees (in newick format) and a list of taxa showcasing the derived character to investigate (parthenogenesis, in this case).  

The first species tree (must be named "tree_1") should have branch lengths in average substitutions per site and branches must be labeled with concordance factors. The second tree (named "tree_2") should have the same branch lengths as tree_1, but have internal branch labels rather than concordance factors. These labels can be arbitrary (I1-I8, in this case).

```
#NEXUS
begin trees;
tree tree_1 = (TBI:0.0216811821,(((TCE:0.0258830720,TMS:0.0223835875)85.6:0.0313337511,((TCM:0.0257016099,TSI:0.0215270659)75:0.0211077249,(TDI:0.0227873921,TPS:0.0298985030)68.4:0.0167929055)73:0.0234755438)83.9:0.0502147658,(TGE:0.0282544807,TPA:0.0490445735)60.1:0.0097146123)79.1:0.0203223997,TTE:0.0170368202);
tree tree_2 = (TBI:0.0216811821,(((TCE:0.0258830720,TMS:0.0223835875)I1:0.0313337511,((TCM:0.0257016099,TSI:0.0215270659)I2:0.0211077249,(TDI:0.0227873921,TPS:0.0298985030)I3:0.0167929055)I4:0.0234755438)I5:0.0502147658,(TGE:0.0282544807,TPA:0.0490445735)I6:0.0097146123)I7:0.0203223997,TTE:0.0170368202)I8;
end;

begin hemiplasytool;
set derived taxon=TDI
set derived taxon=TSI
set derived taxon=TMS
set derived taxon=TGE
set derived taxon=TTE
set conversion type=extend
end;
```

#### Run HeIST


HeIST can be run through the following command line:

```
heist -v -n 100000000 -t 12 -p ../../../HeIST/lib/msdir/ms -g ../../../HeIST/lib/Seq-Gen-1.3.4/source/seq-gen -o ./output_10_aa_0.0005.txt ./heistinput_aa_min10.txt -s 0.0005
```

The flag `-v` (or `--verbose`) enables debugging messages to be displayed.
The flag `-n` specifies the number of replicates per batch.
The flag `-p` specifies the path to ms dependency.
The flag `-g` specifies the path to seq-gen dependency.
The flag `-o` indicates the output directory/prefix.
The flag `-s` specifies the Seq-gen mutation rate.

The Seq-gen mutation rate 
